<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Scenario Lab — AI Accountant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/styles.css" fetchpriority="high">
  <script src="/js/head-include.js"></script>

  <style>
    :root{
      --tile-shadow: 0 10px 30px rgba(0,0,0,.06), 0 2px 8px rgba(0,0,0,.06);
      --card-radius: 18px;
      --muted: #6b7280;
      --assistant-bg: #f8fafc;
      --user-bg: #eef2ff;
      --mint: #10a37f;              /* ChatGPT mint */
      --mint-ghost: rgba(16,163,127,.12);
      --input-bg: #ffffff;
      --input-brd: rgba(0,0,0,.08);
      --input-brd-focus: rgba(16,163,127,.45);
    }

    .lab-hero{ padding: 16px 0 6px; }
    .lab-hero .eyebrow{ font-size:.78rem; color:var(--muted); letter-spacing:.08em; text-transform:uppercase }

    .chat-wrap{
      display:grid;
      grid-template-columns: minmax(0,1fr) 360px;
      gap: 16px;
      align-items: flex-start;
    }
    @media (max-width: 1199.98px){
      .chat-wrap{ grid-template-columns: 1fr; }
      .side-column{ position: relative; top: 0; }
    }

    .chat-card{
      border: 1px solid rgba(0,0,0,.06);
      border-radius: var(--card-radius);
      box-shadow: var(--tile-shadow);
      background: #fff;
      display:flex; flex-direction:column;
      min-height: 70vh; max-height: calc(100vh - 200px);
      overflow:hidden;
      position: relative;
    }

    .chat-body{
      padding: 14px 14px 100px;   /* bottom space for the composer */
      overflow: auto;
      flex: 1 1 auto;
      scroll-behavior: smooth;
    }

    /* Sticky composer (not floating) at bottom of the panel */
    .chat-composer{
      position: absolute;
      left: 0; right: 0; bottom: 0;
      padding: 12px 14px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0), #fff 35%);
      border-top: 1px solid rgba(0,0,0,.05);
    }

    .composer-inner{
      display:flex; align-items:flex-end; gap: 8px;
      background: var(--input-bg);
      border: 1px solid var(--input-brd);
      border-radius: 22px;
      padding: 8px 8px 8px 12px;
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .composer-inner:focus-within{
      border-color: var(--input-brd-focus);
      box-shadow: 0 0 0 4px rgba(16,163,127,.08);
    }

    .composer-text{
      flex: 1 1 auto;
      min-height: 28px; max-height: 180px;
      resize: none; overflow-y: auto;
      border: 0; outline: 0; background: transparent;
      padding: 6px 0 4px;
    }
    .composer-text::placeholder{ color: #9aa3af; }

    .btn-icon{
      display:inline-flex; align-items:center; justify-content:center;
      width: 36px; height: 36px; border-radius: 50%;
      border: 1px solid rgba(0,0,0,.08); background: #fff; cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
    }
    .btn-icon[disabled]{ opacity:.5; cursor:not-allowed; }
    .btn-icon:hover{ transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,.08) }

    /* Dynamic states for send button */
    .btn-send{ border-color: rgba(0,0,0,.08); }
    .btn-send svg{ width:18px; height:18px; display:block; }
    .composer--empty .btn-send{ opacity:.55; }
    .composer--ready .btn-send{ border-color: var(--mint); background: var(--mint-ghost); }
    .composer--ready .btn-send svg{ color: var(--mint); }
    .composer--streaming .btn-send{ opacity:.35; }

    /* Stop button: black pill-like icon */
    .btn-stop{
      border-color: #000; background:#000; color:#fff; width: 36px; height: 36px;
    }
    .btn-stop svg{ width:14px; height:14px; display:block; }

    /* New Chat small */
    .btn-new{ border-radius: 999px; }

    .msg{ display: flex; gap: 10px; margin-bottom: 12px; }
    .msg .bubble{
      padding: 10px 12px; border-radius: 14px; max-width: 920px; white-space: pre-wrap; word-wrap: break-word;
      border: 1px solid rgba(0,0,0,.06);
    }
    .msg.assistant .bubble{ background: var(--assistant-bg); }
    .msg.user .bubble{ background: var(--user-bg); margin-left: auto; }

    .side-column{ display:flex; flex-direction:column; gap:16px; position: sticky; top: 100px; }
    @media (max-width: 1199.98px){ .side-column{ position: static; } }

    .side-card,
    .doc-card{
      border: 1px solid rgba(0,0,0,.06);
      border-radius: var(--card-radius);
      box-shadow: var(--tile-shadow);
      background: #fff;
    }
    .side-card .card-body,
    .doc-card .card-body{ padding: 14px; }
    .example-btn{
      display:block; width:100%; text-align:left;
      border: 1px dashed rgba(0,0,0,.12);
      padding: 10px 12px; border-radius: 12px; background:#fff;
    }

    .disclaimer { color: var(--muted); font-size: .8rem; }

    /* skeleton for first tokens */
    .skeleton{ position: relative; overflow:hidden; background:#f5f5f5; border-radius:8px; height: 14px; margin: 6px 0; }
    .skeleton::after{ content:""; position:absolute; inset:0; transform:translateX(-100%);
      background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.6), rgba(255,255,255,0));
      animation: shimmer 1.2s infinite; }
    @keyframes shimmer { 100% { transform: translateX(100%); } }

    .doc-section summary{ cursor:pointer; font-weight:600; margin-bottom:6px; }
    .doc-section summary::-webkit-details-marker{ display:none; }
    .doc-section summary::after{ content:'\25BC'; float:right; font-size:.75rem; transition: transform .2s ease; }
    .doc-section[open] summary::after{ transform: rotate(180deg); }
    .doc-list{ display:flex; flex-direction:column; gap:10px; }
    .doc-entry{ border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:10px 12px; background:#fafbff; }
    .doc-entry-header{ display:flex; justify-content:space-between; gap:8px; align-items:flex-start; }
    .doc-entry-title{ font-weight:600; font-size:.95rem; }
    .doc-entry-meta{ font-size:.75rem; color:var(--muted); }
    .doc-files{ margin-top:8px; display:flex; flex-direction:column; gap:6px; }
    .doc-files label{ display:flex; align-items:flex-start; gap:6px; font-size:.85rem; cursor:pointer; }
    .doc-files input[type='checkbox']{ margin-top:2px; }
    .doc-empty{ font-size:.8rem; color:var(--muted); }
    .doc-section-title{ font-weight:600; margin:12px 0 6px; }
    .doc-badge-row{ display:flex; flex-wrap:wrap; gap:6px; }
    .doc-badge{ display:inline-flex; align-items:center; gap:4px; padding:4px 10px; border-radius:999px; background:var(--mint-ghost); color:var(--mint); font-size:.75rem; text-decoration:none; border:1px solid rgba(16,163,127,.3); }
    .doc-badge button{ border:0; background:none; padding:0; margin:0; cursor:pointer; color:inherit; }
    .doc-notices{ margin-top:10px; font-size:.8rem; }
    .doc-notices .doc-notice{ padding:6px 8px; border-radius:8px; margin-bottom:6px; border:1px solid rgba(0,0,0,.1); background:#fff6f6; color:#b42318; }
    .doc-notices .doc-notice.success{ background:#f2fbf5; border-color:rgba(16,163,127,.25); color:#0f5132; }
    .doc-notices .doc-notice a{ color:inherit; text-decoration:underline; }
    .doc-hint{ font-size:.76rem; color:var(--muted); margin-bottom:6px; }
    .doc-selected{ margin:10px 0; }

    .bubble{ position:relative; }
    .bubble-content{ white-space:pre-wrap; word-wrap:break-word; }
    .bubble-meta{ margin-top:8px; display:none; }
    .bubble-meta.active{ display:block; }
    .bubble-meta .doc-badge-row{ gap:4px; }
  </style>
</head>
<body>
  <div id="topbar-container"></div>
  <div id="sidebar-container"></div>

  <main class="container py-4">
    <section class="lab-hero">
      <div class="eyebrow">Labs</div>
      <h1 class="page-title" data-page-title>Scenario Lab</h1>
      <div class="mt-1">
        <span class="badge text-bg-light border">OpenAI</span>
        <span class="disclaimer ms-2">Responses are generated. No chat memory is kept after you leave this page.</span>
      </div>
    </section>

    <section class="chat-wrap mt-3">
      <!-- Chat -->
      <div class="chat-card">
        <div id="chat-body" class="chat-body"></div>

        <!-- Composer (sticky, curved, dynamic) -->
        <div class="chat-composer">
          <form id="chat-form" class="composer-inner composer--empty" autocomplete="off">
            <textarea id="chat-text" class="composer-text" rows="1" placeholder="Send a message…" required></textarea>

            <!-- Send (dynamic: grey -> mint arrow) -->
            <button id="btn-send" class="btn-icon btn-send" type="submit" disabled title="Send">
              <!-- Arrow (mint via CSS when ready) -->
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M5 12h14"></path>
                <path d="M12 5l7 7-7 7"></path>
              </svg>
            </button>

            <!-- Stop (black) -->
            <button id="btn-stop" class="btn-icon btn-stop ms-1" type="button" title="Stop" disabled>
              <svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
            </button>

            <!-- New chat (small) -->
            <button id="btn-new" class="btn btn-outline-secondary btn-sm ms-1" type="button">New chat</button>
          </form>
        </div>
      </div>

      <!-- Side panels -->
      <div class="side-column">
        <div class="side-card">
          <div class="card-body">
            <h6 class="mb-2">Examples</h6>
            <button class="example-btn mb-2" data-example="What tax implications should I consider when selling vested RSUs in the UK?">Tax implications for RSUs (UK)</button>
            <button class="example-btn mb-2" data-example="Help me explore scenarios to reduce my capital gains tax if I rebalance my portfolio this year.">CGT scenario planning</button>
            <button class="example-btn mb-2" data-example="Explain how to categorize transactions from multiple bank accounts for budgeting and analytics.">Transaction categorisation</button>
            <hr class="my-3" />
            <div class="small text-muted">Tip: Hold <kbd>Shift</kbd> + <kbd>Enter</kbd> for a new line.</div>
          </div>
        </div>

        <div class="doc-card">
          <div class="card-body" id="doc-panel">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Vault documents</h6>
              <button id="doc-refresh" class="btn btn-link btn-sm px-0" type="button">Refresh</button>
            </div>
            <div class="doc-hint">Link required or helpful evidence from your vault to ground the next answer.</div>
            <div id="doc-loading" class="text-muted small">Loading vault catalogue…</div>
            <div id="doc-error" class="alert alert-warning d-none"></div>
            <div id="doc-selected" class="doc-selected d-none">
              <div class="small text-muted mb-1">Attached to the next reply:</div>
              <div id="doc-selected-list" class="doc-badge-row"></div>
            </div>
            <div id="doc-notices" class="doc-notices d-none"></div>
            <div id="doc-sections" class="doc-sections d-none">
              <details class="doc-section" id="doc-required-wrap" open>
                <summary>Required documents</summary>
                <div class="doc-list" id="doc-required"></div>
              </details>
              <details class="doc-section" id="doc-helpful-wrap">
                <summary>Helpful documents</summary>
                <div class="doc-list" id="doc-helpful"></div>
              </details>
              <div class="doc-section" id="doc-all-wrapper">
                <div class="doc-section-title">All vault files</div>
                <div class="doc-list" id="doc-all"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script src="/js/nav.js"></script>
  <script src="/js/mobile-sidebar.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/auth.js"></script>
  <script>Auth.enforce();</script>
  <script src="/js/scenario-lab.js"></script>
</body>
</html>
