<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Document Vault — AI Accountant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared theme, Bootstrap, Bootstrap Icons, helpers -->
  <script>window.__API_BASE = window.__API_BASE || 'https://ai-accountant-app.onrender.com';</script>
  <script src="/js/head-include.js"></script>
  <script src="/js/http-shim.js"></script>

  <style>
    :root{
      /* Match landing look & feel */
      --tile-gap: 14px;
      --tile-radius: 16px;
      --tile-shadow: 0 10px 30px rgba(0,0,0,.06), 0 2px 8px rgba(0,0,0,.06);
      --tile-shadow-hover: 0 14px 34px rgba(0,0,0,.10), 0 4px 12px rgba(0,0,0,.06);
      --muted: #6b7280;
      --brand: var(--bs-primary, #6f42c1);
      --chip-bg: rgba(111,66,193,.08);
      --chip-fg: var(--brand);
      --bg-soft: var(--bs-light-bg-subtle, #f8f9fa);
    }

    body{ background: var(--bg-body); color: var(--fg); }

    /* Page header */
    .page-header{ position:relative; border-radius: 20px; padding: 18px 18px; background: linear-gradient(180deg, rgba(111,66,193,.10), rgba(111,66,193,.02)); border:1px solid var(--bs-border-color); box-shadow: var(--tile-shadow); }
    .breadcrumbs a{ text-decoration:none }

    /* Stat tiles */
    .stat-card{ border-radius: var(--tile-radius); box-shadow: var(--tile-shadow); border:1px solid var(--bs-border-color); transition: .2s ease; background: var(--bs-body-bg) }
    .stat-card:hover{ box-shadow: var(--tile-shadow-hover); transform: translateY(-1px) }
    .stat-k{ font-weight:700; font-size: 1.3rem; }
    .stat-sub{ color: var(--muted); font-size: .9rem }

    /* Layout */
    .vault-grid{ display:grid; grid-template-columns: 1fr 1.1fr; gap: var(--tile-gap) }
    @media (max-width: 992px){
      .vault-grid{ grid-template-columns: 1fr }
    }

    /* Left column (collections + documents) */
    .panel{ border-radius: var(--tile-radius); border: 1px solid var(--bs-border-color); background: var(--bs-body-bg); box-shadow: var(--tile-shadow); }
    .panel-header{ padding: 14px 16px; border-bottom: 1px solid var(--bs-border-color); display:flex; align-items:center; justify-content:space-between; gap:10px }
    .panel-body{ padding: 10px }

    /* Collections list */
    .collection-item{ display:flex; align-items:center; gap:10px; padding: 10px 12px; border-radius: 12px; cursor:pointer; user-select:none; border:1px solid transparent; }
    .collection-item:hover{ background: var(--bg-soft); border-color: var(--bs-border-color); }
    .collection-item.active{ background: rgba(111,66,193,.08); border-color: rgba(111,66,193,.25) }
    .collection-name{ font-weight:600 }
    .collection-meta{ color: var(--muted); font-size:.88rem }

    /* Document list */
    .doc-row{ display:grid; grid-template-columns: 1fr auto; gap:10px; padding: 12px 14px; border-radius: 14px; align-items:center; border:1px solid transparent; }
    .doc-row:hover{ background: var(--bg-soft); border-color: var(--bs-border-color) }
    .doc-main{ display:flex; align-items:center; gap:12px; min-width:0 }
    .doc-title{ font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .doc-sub{ color: var(--muted); font-size:.88rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .doc-actions{ display:flex; align-items:center; gap:10px; opacity:.85 }
    .doc-actions .btn-icon{ border:none; background:transparent; padding:6px; border-radius:10px }
    .doc-actions .btn-icon:hover{ background: rgba(0,0,0,.06) }

    /* Right column (dropzone + preview) */
    .dropzone-card{ border-radius: var(--tile-radius); border: 1px dashed rgba(111,66,193,.35); background: linear-gradient(180deg, rgba(111,66,193,.06), rgba(111,66,193,.02)); box-shadow: var(--tile-shadow); padding: 18px }
    .dropzone-card .hint{ color: var(--muted) }
    #dropzone{ border: 2px dashed rgba(111,66,193,.45); border-radius: 16px; padding: 0; background: rgba(111,66,193,.04); overflow:hidden }
    #dropzone .dz-clickable-area{ padding: 28px; display:flex; align-items:center; justify-content:center; text-align:center; min-height: 96px; }

    .preview-card{ border-radius: var(--tile-radius); border: 1px solid var(--bs-border-color); box-shadow: var(--tile-shadow); overflow:hidden; }
    .preview-header{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom: 1px solid var(--bs-border-color) }
    .preview-body{ background: #fff; height: 420px; }
    .preview-body iframe{ width:100%; height:100%; border:0 }

    .search-input{ background: var(--bs-body-bg) }

    /* Keep counters readable */
    .kpi{ display:flex; align-items:center; gap:8px }
    .kpi i{ font-size: 1.15rem }

    /* Subtle scrollbar for lists */
    .scroll-area{ max-height: 48vh; overflow:auto; padding-right: 4px }

    /* Utility */
    .muted{ color: var(--muted) }
    .chip{ font-size:.78rem; padding:.1rem .5rem; background: var(--chip-bg); color: var(--chip-fg); border-radius: 999px }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Enforce auth if present
      if (window.Auth && typeof Auth.enforce === 'function') Auth.enforce(true);

      // Enable Bootstrap tooltips (purely aesthetic)
      if (window.bootstrap) {
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
      }
    });
  </script>
</head>
<body>
  <div id="topbar-container"></div>
  <div id="sidebar-container"></div>

  <main class="container-xxl py-4">

    <!-- Header / Breadcrumbs -->
    <div class="page-header mb-3">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
        <div>
          <h1 class="h3 mb-1">Document Vault</h1>
          <div class="breadcrumbs small">
            <a href="#" class="text-body" id="crumb-home"><i class="bi bi-house-door"></i> Home</a>
            <span class="mx-1">/</span>
            <span class="text-body" id="crumb-vault">Vault</span>
            <span class="mx-1">/</span>
            <span class="text-muted" id="current-collection-name">All documents</span>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="chip" id="active-tax-year">Tax year: <span id="tax-year-label">2025/26</span></span>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-4">
        <div class="stat-card p-3 d-flex align-items-center justify-content-between">
          <div>
            <div class="stat-k" id="file-count">0</div>
            <div class="stat-sub">Files</div>
          </div>
          <div class="kpi text-primary"><i class="bi bi-files"></i></div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="stat-card p-3 d-flex align-items-center justify-content-between">
          <div>
            <div class="stat-k" id="total-gb">0 GB</div>
            <div class="stat-sub">Total storage used</div>
          </div>
          <div class="kpi text-primary"><i class="bi bi-hdd"></i></div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="stat-card p-3 d-flex align-items-center justify-content-between">
          <div>
            <div class="stat-k" id="collection-count">0</div>
            <div class="stat-sub">Collections</div>
          </div>
          <div class="kpi text-primary"><i class="bi bi-folder2"></i></div>
        </div>
      </div>
    </div>

    <!-- Main grid: Left (lists) | Right (dropzone + preview) -->
    <div class="vault-grid">

      <!-- LEFT: Collections + Documents -->
      <section class="panel">
        <div class="panel-header">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-collection text-primary"></i>
            <strong>Collections</strong>
          </div>
          <div class="d-flex align-items-center gap-2">
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-transparent border-end-0"><i class="bi bi-search"></i></span>
              <input id="collection-search" class="form-control border-start-0 search-input" placeholder="Search collections…" />
            </div>
            <button id="new-collection-btn" type="button" class="btn btn-sm btn-primary">
              <i class="bi bi-folder-plus"></i> New
            </button>
          </div>
        </div>
        <div class="panel-body">
          <!-- Collections containers (compat: provide multiple expected IDs) -->
          <div id="collections" class="mb-3">
            <div id="collections-list" class="scroll-area">
              <!-- Backend will populate .collection-item elements here -->
            </div>
            <!-- Some builds used #collection-list -->
            <div id="collection-list" class="scroll-area d-none"></div>
          </div>

          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-journals text-primary"></i>
              <strong>Documents</strong>
            </div>
            <a href="#" id="back-to-collections" class="small text-decoration-none"><i class="bi bi-arrow-left"></i> Back to all collections</a>
          </div>

          <!-- Documents containers (compat: several IDs) -->
          <div id="documents">
            <div id="documents-list" class="scroll-area"></div>
            <div id="document-list" class="scroll-area"></div>
          </div>
        </div>
      </section>

      <!-- RIGHT: Dropzone + Preview (preview under dropzone) -->
      <section class="d-flex flex-column gap-3">
        <!-- Upload / Dropzone (keep id for backend wiring; use <form> for Dropzone.js compatibility) -->
        <div class="dropzone-card">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-upload text-primary"></i>
              <strong>Upload files</strong>
            </div>
            <div class="hint small">Drag and drop files, or click to browse</div>
          </div>

          <form id="dropzone" class="dropzone bg-white" action="#" method="post" enctype="multipart/form-data">
            <!-- Compat clickable area for custom uploaders if Dropzone isn't used -->
            <div class="dz-clickable-area">
              <i class="bi bi-cloud-arrow-up me-2"></i>
              <span class="small text-muted">Drop files here or click to upload</span>
            </div>
            <input id="file-input" name="file" type="file" multiple class="d-none" />
          </form>

          <!-- Legacy alias container some builds used -->
          <div id="upload-dropzone" class="d-none"></div>
        </div>

        <!-- Preview card (sits directly under the dropzone) -->
        <div class="preview-card">
          <div class="preview-header">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-eye text-primary"></i>
              <strong>Preview</strong>
            </div>
            <div class="small text-muted" id="preview-filename">—</div>
          </div>
          <div class="preview-body">
            <div class="h-100 d-flex align-items-center justify-content-center text-muted" id="preview-empty">Select a document to preview</div>
            <iframe id="preview-frame" class="d-none" title="Preview"></iframe>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- New Collection Modal (IDs only; backend can hook listeners; aesthetic only) -->
  <div class="modal fade" id="new-collection-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-folder-plus me-2"></i>Create collection</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="new-collection-form">
          <div class="modal-body">
            <label for="new-collection-name" class="form-label">Name</label>
            <input id="new-collection-name" class="form-control" placeholder="e.g., Payslips, Invoices" required />
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Create</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Compatibility helpers that DON'T replace your backend logic.
    (function(){
      // 1) If your code expects #collection-list (old id), mirror #collections-list into it.
      const colList = document.getElementById('collections-list');
      const colListOld = document.getElementById('collection-list');
      if (colList && colListOld) { colListOld.replaceWith(colList); colList.id = 'collection-list'; }

      // 2) If your code expects #documents-list or #document-list, ensure at least one exists with content
      const docsList = document.getElementById('documents-list');
      const docList = document.getElementById('document-list');
      if (docsList && docList) { docList.replaceWith(docsList); docsList.id = 'document-list'; }

      // 3) Wire simple click-to-file if your uploader doesn't auto-bind
      const dz = document.getElementById('dropzone');
      const fi = document.getElementById('file-input');
      if (dz && fi) {
        dz.addEventListener('click', (e) => {
          const isClickable = e.target.closest('.dz-clickable-area') || e.target === dz;
          if (isClickable) fi.click();
        });
      }

      // 4) Lightweight preview for rows with data-preview-url (aesthetic only)
      const list = document.getElementById('document-list');
      const nameLabel = document.getElementById('preview-filename');
      const frame = document.getElementById('preview-frame');
      const empty = document.getElementById('preview-empty');
      if (list && frame && nameLabel && empty) {
        list.addEventListener('click', (e) => {
          const row = e.target.closest('.doc-row,[data-preview-url]');
          if (!row) return;
          const url = row.getAttribute('data-preview-url');
          const name = row.getAttribute('data-filename') || row.querySelector('.doc-title')?.textContent || 'Preview';
          if (url) {
            nameLabel.textContent = name;
            frame.src = url;
            empty.classList.add('d-none');
            frame.classList.remove('d-none');
          }
        });
      }

      // 5) If your app opens a modal to create collections, show ours when the button is clicked (non-invasive)
      const newBtn = document.getElementById('new-collection-btn');
      const modalEl = document.getElementById('new-collection-modal');
      if (newBtn && modalEl && window.bootstrap) {
        const m = new bootstrap.Modal(modalEl);
        newBtn.addEventListener('click', () => m.show());
      }
    })();
  </script>

  <!-- IMPORTANT: include possible page scripts so original logic runs -->
  <script src="/js/document-vault.js"></script>
  <script src="/js/vault.js"></script>
</body>
</html>
