<!doctype html>
<html lang="en">
<head>
  <!-- Your common libs (Bootstrap, Icons, styles) -->
  <script src="/js/head-include.js"></script>

  <!-- ALWAYS send cookies on /api/* fetches -->
  <script defer src="/js/http-shim.js?v=2025-09-15a"></script>

  <!-- Auth shim (superset with setBannerTitle, requireAuth aliases, safe no-ops) -->
  <script defer src="/js/auth.js?v=2025-09-15a"></script>

  <!-- Enforce auth BEFORE any page code runs -->
  <script defer>
    window.addEventListener('DOMContentLoaded', () => {
      if (window.Auth && typeof Auth.enforce === 'function') {
        Auth.enforce(true);
      }
    });
  </script>

  <!-- App config (ok to come after auth) -->
  <script defer src="/js/config.js?v=2025-09-15a"></script>

  <!-- UI chrome may read Auth state; load after auth -->
  <script defer src="/js/nav.js?v=2025-09-15a"></script>

  <!-- Page logic LAST (it may call Auth.setBannerTitle, etc.) -->
  <script defer src="/js/dashboard.js?v=2025-09-15a"></script>
</head>
</head>
<body>
  <div id="topbar-container"></div>
  <div id="sidebar-container"></div>

  <main class="container py-4">
    <h1 class="page-title" data-page-title>Dashboard</h1>

    <!-- Greeting -->
    <div class="alert alert-light border d-flex justify-content-between align-items-center">
      <div>Welcome, <strong id="greeting-name">—</strong>.</div>
      <div class="text-muted small" id="dash-year">Tax year —</div>
    </div>

    <!-- Global Time Range Picker -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
          <div class="d-flex align-items-center gap-2">
            <strong>Time range</strong>
            <span id="range-current" class="text-muted small">—</span>
          </div>
          <div class="btn-group" role="group" aria-label="Mode">
            <button id="rng-btn-quick" class="btn btn-sm btn-outline-primary active" type="button">Quick options</button>
            <button id="rng-btn-custom" class="btn btn-sm btn-outline-primary" type="button">Custom</button>
          </div>
        </div>

        <!-- QUICK -->
        <div id="rng-quick" class="mt-2">
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="rngQuick" id="rng-last-month" value="last-month">
            <label class="form-check-label" for="rng-last-month">Last month</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="rngQuick" id="rng-last-quarter" value="last-quarter">
            <label class="form-check-label" for="rng-last-quarter">Last quarter</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="rngQuick" id="rng-last-year" value="last-year">
            <label class="form-check-label" for="rng-last-year">Last year</label>
          </div>
          <button class="btn btn-sm btn-primary ms-2" id="rng-apply-quick" type="button">Apply</button>
        </div>

        <!-- CUSTOM -->
        <div id="rng-custom" class="mt-2" style="display:none;">
          <div class="row g-2 align-items-end">
            <div class="col-auto">
              <label for="rng-start" class="form-label mb-1">Start</label>
              <input type="date" class="form-control form-control-sm" id="rng-start">
            </div>
            <div class="col-auto">
              <label for="rng-end" class="form-label mb-1">End</label>
              <input type="date" class="form-control form-control-sm" id="rng-end">
            </div>
            <div class="col-auto">
              <button class="btn btn-sm btn-primary" id="rng-apply-custom" type="button">Apply</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- KPIs: Tax band, HMRC position, Income, Spend -->
<div class="row g-3 mb-3" id="kpi-row">
  <div class="col-6 col-lg-3">
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex flex-column justify-content-center">
        <div class="text-muted small">Tax band</div>
        <div class="h4 m-0" id="kpi-tax-band">—</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-lg-3">
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex flex-column justify-content-center">
        <div class="text-muted small">HMRC position (range)</div>
        <div class="h4 m-0" id="kpi-tax-pos">—</div>
        <div class="text-muted small" id="kpi-tax-pos-sub">—</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-lg-3">
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex flex-column justify-content-center">
        <div class="text-muted small">Income (selected)</div>
        <div class="h4 m-0" id="kpi-income">£—</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-lg-3">
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex flex-column justify-content-center">
        <div class="text-muted small">Spend (selected)</div>
        <div class="h4 m-0" id="kpi-spend">£—</div>
      </div>
    </div>
  </div>
</div>


    <!-- Row 1: Waterfall + EMTR -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-lg-7">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="card-title m-0">Take-home Waterfall</h5>
              <button class="btn btn-sm btn-outline-secondary" id="wf-details">View why</button>
            </div>
            <canvas id="chart-waterfall" height="140"></canvas>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-5">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h5 class="card-title">EMTR (Effective marginal tax rate)</h5>
            <canvas id="chart-emtr" height="140"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 2: Gauges + Upcoming Events -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-lg-7">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h5 class="card-title">Allowance usage</h5>
            <div id="gauges" class="row g-3"></div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-5">
        <div class="card shadow-sm h-100">
          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="card-title m-0">Upcoming events</h5>
            </div>
            <div id="events-scroll" class="mt-2" style="max-height: 340px; overflow: auto;">
              <table class="table table-sm table-hover align-middle mb-0" id="events-table">
                <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
                  <tr><th style="width:110px;">Date</th><th>Event</th><th style="width:36px;"></th></tr>
                </thead>
                <tbody id="events-tbody"></tbody>
              </table>
            </div>
            <div id="events-empty" class="text-muted small mt-2">No upcoming events yet.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Financial Posture -->
    <section class="mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="m-0">Financial Posture</h4>
        <div class="text-muted small">Summary reflects selected time range</div>
      </div>
      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="card-title m-0">Net worth snapshot</h5>
                <div class="text-muted small" id="fp-networth-date">—</div>
              </div>
              <div class="row g-3">
                <div class="col-7">
                  <div class="display-6 fw-semibold" id="fp-networth-total">£—</div>
                  <div class="text-muted small mb-2">Assets minus liabilities</div>
                  <ul class="list-unstyled mb-0" id="fp-networth-breakdown"></ul>
                </div>
                <div class="col-5"><canvas id="fp-networth-chart" height="160"></canvas></div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-6">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h5 class="card-title">Income & spend (selected)</h5>
              <div class="row g-3 align-items-center">
                <div class="col-6">
                  <div class="fw-semibold">Total income</div>
                  <div class="h3 m-0" id="fp-inc-total">£—</div>
                  <div class="text-muted small" id="fp-inc-notes">—</div>
                </div>
                <div class="col-6">
                  <div class="fw-semibold">Total spent</div>
                  <div class="h3 m-0" id="fp-spend-total">£—</div>
                  <div class="text-muted small" id="fp-spend-notes">—</div>
                </div>
              </div>
              <div class="mt-3"><canvas id="fp-incspend-chart" height="120"></canvas></div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-6">
          <div class="card shadow-sm h-100">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">Biggest costs (selected)</h5>
              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead class="table-light"><tr><th>Category</th><th class="text-end" style="width:140px;">Amount</th></tr></thead>
                  <tbody id="fp-top-costs-body"></tbody>
                </table>
              </div>
              <div class="text-muted small mt-2">Top 5 categories by spend.</div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-6">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title m-0">Investments overview</h5>
                <div class="badge text-bg-success" id="fp-perf-ytd">YTD —%</div>
              </div>
              <div class="row g-3">
                <div class="col-6">
                  <canvas id="fp-allocation-chart" height="150"></canvas>
                  <div class="text-muted small text-center mt-1">Asset allocation</div>
                </div>
                <div class="col-6">
                  <canvas id="fp-portfolio-line" height="150"></canvas>
                  <div class="text-muted small text-center mt-1">Portfolio value (12m)</div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>
  </main>
</body>
</html>
</html>
